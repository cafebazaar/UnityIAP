<article class="markdown-body entry-content" itemprop="mainContentOfPage">
  <h2>Bazaar In-app Billing for Unity3d</h2>
  <p><em>In order to provide Iab for Unity3d, Bazaar used <a href="http://soom.la">SOOMLA</a> which is the first store creation platform for mobile games. SOOMLA   helps you to easily create your in-game economy and storefront. You can check SOOMLA's github  <a href="https://github.com/soomla/unity3d-store"> (here</a>) for more information.</em></p>
  <h2><a name="getting-started" class="anchor" href="#getting-started"><span class="octicon octicon-link"></span></a>Getting Started</h2><ol>
    <li>Download  Bazaar unitypackage file here and double-click on it. It'll import all the necessary files into your project.</li><li>Drag the "StoreEvents" Prefab from <code>../Assets/Soomla/Prefabs</code> into your scene. You should see it listed in the "Hierarchy" panel.</li><li>On the menu bar click "Soomla -&gt; Edit Settings" and change the values for "Custom Secret", "Public Key" and "Soom Sec":

<ul><li><em>Custom Secret</em> - is an encryption secret you provide that will be used to secure your data.</li>
<li><em>Public Key</em> - is the public key given to you from <a href="http://pardakht.cafebazaar.ir/panel/?l=en">Bazaar</a>. (iOS doesn't have a public key).</li><li><em>Soom Sec</em> - is a special secret SOOMLA uses to increase your data protection.<br><strong>Choose both secrets wisely. You can't change them after you launch your game!</strong></li></ul></li><li><p>Create your own implementation of <em>IStoreAssets</em> in order to describe your specific game's assets (<a href="https://github.com/soomla/unity3d-store/blob/master/unity4.0/Assets/Examples/MuffinRush/MuffinRushAssets.cs">example</a>). Initialize <em>StoreController</em> with the class you just created:</p><div class="highlight highlight-cs"><pre><span class="n">StoreController</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="k">new</span><span class="n">YourStoreAssetsImplementation</span><span class="p">());</span></pre></div><blockquote><p style="font-size:14px">Initialize <em>StoreController</em> ONLY ONCE when your application loads.</p><p style="font-size:14px">Initialize <em>StoreController</em> in the "Start()" function of a 'MonoBehaviour' and <strong>NOT</strong> in the "Awake()" function. SOOMLA has its own 'MonoBehaviour' and it needs to be "Awakened" before you initialize.</p></blockquote></li><li><p>You'll need an event handler in order to be notified about in-app purchasing related events. refer to the <a href="#event-handling">Event Handling</a> section for more information.</p></li></ol><p>And that's it ! You have storage and in-app purchasing capabilities... ALL-IN-ONE.</p><h3><a name="unity--android" class="anchor" href="#unity--android"><span class="octicon octicon-link"></span></a>Unity &amp; Android</h3><h4><a name="starting-iab-service-in-background" class="anchor" href="#starting-iab-service-in-background"><span class="octicon octicon-link"></span></a>Starting IAB Service in background</h4><p>If you have your own storefront implemented inside your game, it's recommended that you open the IAB Service in the background when the store opens and close it when the store is closed.</p><div class="highlight highlight-cs"><pre><span class="c1">// Start Iab Service</span><span class="n">StoreController</span><span class="p">.</span><span class="n">StartIabServiceInBg</span><span class="p">();</span><span class="c1">// Stop Iab Service</span><span class="n">StoreController</span><span class="p">.</span><span class="n">StopIabServiceInBg</span><span class="p">();</span></pre></div><p>Don't forget to close the Iab Service when your store is closed. You don't have to do this at all, this is just an optimization.</p><h2><a name="whats-next-in-app-purchasing" class="anchor" href="#whats-next-in-app-purchasing"><span class="octicon octicon-link"></span></a>What's next? In App Purchasing.</h2>
<p>Soomla  designed the new modelV3 to support 2 ways you can let your users purchase stuff in your game: PurchaseWithMarket and PurchaseWithVirtualItem.</p><p><strong>PurchaseWithMarket</strong> is a PurchaseType that allows users to purchase a VirtualItem with Google Play or the App Store.<br><strong>PurchaseWithVirtualItem</strong> is a PurchaseType that lets your users purchase a VirtualItem with a different VirtualItem. For Example: Buying 1 Sword with 100 Gems.</p><p>In order to define the way your various virtual items (Goods, Coins ...) are purchased, you'll need to create your implementation of IStoreAsset (the same one from step 4 in the "Getting Started" above).</p><p>Here is an example:</p><p>Lets say you have a <em>VirtualCurrencyPack</em> you call <code>TEN_COINS_PACK</code> and a <em>VirtualCurrency</em> you call <code>COIN_CURRENCY</code>:</p><div class="highlight highlight-cs"><pre><span class="n">VirtualCurrencyPack</span><span class="n">TEN_COINS_PACK</span><span class="p">=</span><span class="k">new</span><span class="n">VirtualCurrencyPack</span><span class="p">(</span><span class="s">"10 Coins"</span><span class="p">,</span><span class="c1">// name</span><span class="s">"A pack of 10 coins"</span><span class="p">,</span><span class="c1">// description</span><span class="s">"10_coins"</span><span class="p">,</span><span class="c1">// item id</span><span class="m">10</span><span class="p">,</span><span class="c1">// number of currencies in the pack</span><span class="n">COIN_CURRENCY_ITEM_ID</span><span class="p">,</span><span class="c1">// the currency associated with this pack</span><span class="k">new</span><span class="nf">PurchaseWithMarket</span><span class="p">(</span><span class="s">"com.soomla.ten_coin_pack"</span><span class="p">,</span><span class="m">1.99</span><span class="p">)</span><span class="p">);</span></pre></div><p>Now you can use <em>StoreInventory</em> to buy your new VirtualCurrencyPack:</p><div class="highlight highlight-cs"><pre><span class="n">StoreInventory</span><span class="p">.</span><span class="n">buyItem</span><span class="p">(</span><span class="n">TEN_COINS_PACK</span><span class="p">.</span><span class="n">ItemId</span><span class="p">);</span></pre></div>
<p>And that's it! SOOMLA knows how to contact Bazaar  and will redirect your users to their purchasing system to complete the transaction. Don't forget to subscribe to store events in order to get the notified of successful or failed purchases (see <a href="#event-handling">Event Handling</a>).</p><h2><a name="storage--meta-data" class="anchor" href="#storage--meta-data"><span class="octicon octicon-link"></span></a>Storage &amp; Meta-Data</h2><p>When you initialize <em>StoreController</em>, it automatically initializes two other classes: <em>StoreInventory</em> and <em>StoreInfo</em>:  </p><ul><li><em>StoreInventory</em> is a convenience class to let you perform operations on VirtualCurrencies and VirtualGoods. Use it to fetch/change the balances of VirtualItems in your game (using their ItemIds!)<br></li><li><em>StoreInfo</em> is where all meta data information about your specific game can be retrieved. It is initialized with your implementation of <code>IStoreAssets</code> and you can use it to retrieve information about your specific game.</li></ul>
<p><strong>ATTENTION: because SOOMLA is using JNI (Android)  you should make as little calls as possible to <em>StoreInfo</em>. Look in the example project for the way SOOMLA created a sort of a cache to hold your game's information in order to not make too many calls to <em>StoreInfo</em>. SOOMLA updates this cache using an event handler. (see <a href="https://github.com/soomla/unity3d-store/blob/master/unity4.0/Assets/Soomla/Code/ExampleLocalStoreInfo.cs">ExampleLocalStoreInfo</a> and <a href="https://github.com/soomla/unity3d-store/blob/master/unity4.0/Assets/Soomla/Code/ExampleEventHandler.cs">ExampleEventHandler</a>).</strong></p><p><strong>Example Usages</strong></p><ul><li><p>Get VirtualCurrency with itemId "currency_coin":</p><div class="highlight highlight-cs"><pre><span class="n">VirtualCurrency</span><span class="n">coin</span><span class="p">=</span><span class="n">StoreInfo</span><span class="p">.</span><span class="n">GetVirtualCurrencyByItemId</span><span class="p">(</span><span class="s">"currency_coin"</span><span class="p">);</span></pre></div></li><li><p>Give the user 10 pieces of a virtual currency with itemId "currency_coin":</p><div class="highlight highlight-cs"><pre><span class="n">StoreInventory</span><span class="p">.</span><span class="n">GiveItem</span><span class="p">(</span><span class="s">"currency_coin"</span><span class="p">,</span><span class="m">10</span><span class="p">);</span></pre></div></li><li><p>Take 10 virtual goods with itemId "green_hat":</p><div class="highlight highlight-cs"><pre><span class="n">StoreInventory</span><span class="p">.</span><span class="n">TakeItem</span><span class="p">(</span><span class="s">"green_hat"</span><span class="p">,</span><span class="m">10</span><span class="p">);</span></pre></div></li><li><p>Get the current balance of green hats (virtual goods with itemId "green_hat"):</p><div class="highlight highlight-cs"><pre><span class="kt">int</span><span class="n">greenHatsBalance</span><span class="p">=</span><span class="n">StoreInventory</span><span class="p">.</span><span class="n">GetItemBalance</span><span class="p">(</span><span class="s">"green_hat"</span><span class="p">);</span></pre></div></li></ul><h2><a name="event-handling" class="anchor" href="#event-handling"><span class="octicon octicon-link"></span></a>Event Handling</h2><p>SOOMLA lets you subscribe to store events, get notified and implement your own application specific behaviour to those events.</p><blockquote><p style="font-size:14px">Your behaviour is an addition to the default behaviour implemented by SOOMLA. You don't replace SOOMLA's behaviour.</p></blockquote><p>The 'Events' class is where all event go through. To handle various events, just add your specific behaviour to the delegates in the Events class.</p><p>For example, if you want to 'listen' to a MerketPurchase event:</p><div class="highlight highlight-cs">
<pre>
Events.OnMarketPurchase += onMarketPurchase;

public void onMarketPurchase(PurchasableVirtualItem pvi) {
    Debug.Log("Going to purchase an item with productId: " + pvi.ItemId);
}
</pre>
</div></article>
